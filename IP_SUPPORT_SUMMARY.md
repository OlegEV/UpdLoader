# Поддержка индивидуальных предпринимателей (ИП) в УПД

## Описание изменений

Добавлена поддержка обработки УПД документов, где покупателем или продавцом является индивидуальный предприниматель (ИП). В таких случаях ИНН находится в поле `ИННФЛ` вместо стандартного `ИННЮЛ` для юридических лиц.

## Структура XML для ИП

```xml
<СвПокуп>
    <ИдСв>
        <СвИП ИННФЛ="781490187318">
            <ФИО Фамилия="Брагарь" Имя="Андрей" Отчество="Владимирович"/>
        </СвИП>
    </ИдСв>
</СвПокуп>
```

## Внесенные изменения

### 1. Модификация парсера УПД (`src/upd_parser.py`)

#### Метод `_parse_buyer_info()`:
- Добавлен поиск элемента `СвИП` для индивидуальных предпринимателей
- Извлечение ИНН из атрибута `ИННФЛ`
- Формирование полного имени из элемента `ФИО` (Фамилия + Имя + Отчество)
- Логика fallback: сначала ищется юридическое лицо, затем ИП
- Добавлена обработка ошибок с остановкой процесса при отсутствии ИНН

#### Метод `_parse_seller_info()`:
- Аналогичные изменения для обработки продавца-ИП
- Та же логика поиска и обработки ошибок

### 2. Модификация API МойСклад (`src/moysklad_api.py`)

#### Метод `_get_or_create_counterparty()`:
- Добавлено определение типа контрагента по длине ИНН:
  - 12 цифр = индивидуальный предприниматель (`companyType: "individual"`)
  - 10 цифр = юридическое лицо (`companyType: "legal"`)
- КПП указывается только для юридических лиц
- Улучшено логирование для отслеживания типа создаваемого контрагента

## Логика обработки

1. **Поиск юридического лица**: Сначала система ищет элемент `СвЮЛУч` с атрибутом `ИННЮЛ`
2. **Поиск ИП при неудаче**: Если ЮЛ не найдено или у него нет ИНН, ищется элемент `СвИП` с атрибутом `ИННФЛ`
3. **Обработка ошибок**: Если не найден ни один тип с корректным ИНН, процесс останавливается с ошибкой
4. **Создание контрагента**: В МойСклад создается контрагент соответствующего типа на основе длины ИНН

## Тестирование

Создан файл `test_ip_parsing.py` с комплексными тестами:

- ✅ Парсинг ИП как покупателя
- ✅ Парсинг ИП как продавца  
- ✅ Обработка ошибки отсутствия ИНН
- ✅ Определение типа контрагента по длине ИНН

Все тесты прошли успешно.

## Примеры использования

### ИП как покупатель:
```xml
<СвПокуп>
    <ИдСв>
        <СвИП ИННФЛ="781490187318">
            <ФИО Фамилия="Брагарь" Имя="Андрей" Отчество="Владимирович"/>
        </СвИП>
    </ИдСв>
</СвПокуп>
```

Результат: `Organization(name="Брагарь Андрей Владимирович", inn="781490187318", kpp=None)`

### ИП как продавец:
```xml
<СвПрод>
    <ИдСв>
        <СвИП ИННФЛ="123456789012">
            <ФИО Фамилия="Иванов" Имя="Иван" Отчество="Иванович"/>
        </СвИП>
    </ИдСв>
</СвПрод>
```

Результат: `Organization(name="Иванов Иван Иванович", inn="123456789012", kpp=None)`

## Обработка ошибок

При отсутствии ИНН система выдает ошибку:
```
UPDParsingError: "Не удалось определить ИНН покупателя в УПД документе. Проверьте корректность документа."
```

Это останавливает дальнейшую обработку, как требовалось в задаче.

## Совместимость

Изменения полностью обратно совместимы:
- Существующие УПД с юридическими лицами обрабатываются как прежде
- Добавлена поддержка новых случаев с ИП
- Не нарушена работа с существующими документами