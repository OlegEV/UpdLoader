# Рефакторинг создания счета и привязки к заказу

## Описание изменений

Переделан процесс создания счета покупателю и привязки его к заказу покупателя в МойСклад API. Теперь процесс разделен на отдельные этапы:

### Старый процесс (до рефакторинга)
1. Создание заказа покупателя
2. Создание счета покупателю **с привязкой к заказу** в одном запросе

### Новый процесс (после рефакторинга)
1. Создание заказа покупателя
2. Создание счета покупателю **БЕЗ привязки к заказу**
3. **Отдельный запрос** для привязки счета к заказу

## Измененные файлы

### `src/moysklad_api.py`

#### Изменен метод `create_customer_order_and_invoice()`
- Теперь использует новую последовательность вызовов
- Добавлен третий шаг - привязка счета к заказу

#### Добавлен новый метод `_create_customer_invoice_without_order()`
- Создает счет покупателю без привязки к заказу
- Аналогичен старому методу, но без поля `customerOrders`

#### Добавлен новый метод `_link_invoice_to_order()`
- Выполняет привязку существующего счета к заказу
- Использует PUT запрос для обновления счета
- Добавляет поле `customerOrders` к существующему счету

#### Сохранен старый метод `_create_customer_invoice()` для совместимости
- Помечен как "старый метод для совместимости"
- Продолжает работать как раньше

## Последовательность API запросов

### Новая последовательность:
```
1. POST /entity/customerorder          - создание заказа
2. POST /entity/invoiceout            - создание счета (без customerOrders)
3. PUT  /entity/invoiceout/{id}       - привязка счета к заказу
```

### Старая последовательность:
```
1. POST /entity/customerorder          - создание заказа
2. POST /entity/invoiceout            - создание счета (с customerOrders)
```

## Преимущества нового подхода

1. **Разделение ответственности**: Создание и привязка - отдельные операции
2. **Лучшая отказоустойчивость**: Если привязка не удалась, счет уже создан
3. **Гибкость**: Можно создавать счета без заказов и привязывать позже
4. **Логирование**: Более детальное отслеживание каждого этапа
5. **Отладка**: Проще найти проблему на конкретном этапе

## Тестирование

Создан тест `test_refactored_invoice_creation.py` который:
- Парсит тестовый счет
- Создает уникальные номера документов (избегает дубликатов)
- Проверяет все три этапа создания
- Выводит ссылки на созданные документы в МойСклад

### Результат тестирования:
```
✅ ВСЕ ДОКУМЕНТЫ УСПЕШНО СОЗДАНЫ!
   • Заказ покупателя: П239-1751381799 (ID: 9a320880-568b-11f0-0a80-18f0002517c4)
   • Счет покупателю: 239-1751381799 (ID: 9bd2343a-568b-11f0-0a80-0cbb0025dfbd)
   • ✅ Привязка выполнена успешно (статус 200)
```

## Обратная совместимость

Все существующие вызовы `create_customer_order_and_invoice()` продолжают работать без изменений. Внутренняя реализация изменена, но внешний интерфейс остался прежним.

## Логирование

Добавлено детальное логирование каждого этапа:
- `Создаю заказ покупателя...`
- `Создаю счет покупателю...`
- `Привязываю счет к заказу...`
- `✅ Счет {id} успешно привязан к заказу {name}`

## Заключение

Рефакторинг успешно завершен. Новый процесс более надежен и предоставляет лучший контроль над каждым этапом создания документов в МойСклад.